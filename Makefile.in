BINDIR = @BINDIR@
LIBDIR = @LIBDIR@
SYSCONFDIR = @SYSCONFDIR@
MANDIR = @MANDIR@
DATADIR = @DATADIR@
DEBCONFIGDIR = @DEBCONFIGDIR@

POD2MAN = @POD2MAN@
MSGFMT = @MSGFMT@

VERSION = @VERSION@

LANGUAGES = @LANGUAGES@

HOME_DIR = /home/$(USER)
OUT_SCRIPT = debbuild.out

.DEFAULT_GOAL := build
.PHONY: build
build: $(OUT_SCRIPT)

$(OUT_SCRIPT): debbuild
	cp debbuild $(OUT_SCRIPT)
	echo "\
version:$(VERSION)\n\
debconfigdir:$(DEBCONFIGDIR)\n\
sysconfdir:$(SYSCONFDIR)" >> $(OUT_SCRIPT)
	chmod +x $(OUT_SCRIPT)

.PHONY: check
check:
	yath

.PHONY: install install_user_macros install_user_build_tree install_user_files
install:
	rm -rf $(DESTDIR)

	install -d $(DESTDIR)$(BINDIR)
	install $(OUT_SCRIPT) $(DESTDIR)$(BINDIR)/debbuild

	install -d $(DESTDIR)$(DEBCONFIGDIR)
	install -m 644 macros/macros.in $(DESTDIR)$(DEBCONFIGDIR)/macros
	install -m 644 config/debrc $(DESTDIR)$(DEBCONFIGDIR)

	install -m 755 scripts/find-lang.pl $(DESTDIR)$(DEBCONFIGDIR)

	install -d $(DESTDIR)$(DEBCONFIGDIR)/macros.d
	install -m 644 macros/macros.sysutils $(DESTDIR)$(DEBCONFIGDIR)/macros.d
	install -m 644 macros/macros.texlive $(DESTDIR)$(DEBCONFIGDIR)/macros.d
	install -m 644 macros/platform.in $(DESTDIR)$(DEBCONFIGDIR)/macros.d/macros.00platform

	install -d $(DESTDIR)$(MANDIR)/man8
	$(POD2MAN) --utf8 --center="System Manager's Manual" --section 8 \
		--release="Release $(VERSION)" debbuild \
		$(DESTDIR)$(MANDIR)/man8/debbuild.8

	for lang in $(LANGUAGES) ; do \
		install -d $(DESTDIR)$(DATADIR)/locale/$$lang/LC_MESSAGES ; \
		$(MSGFMT) po/$$lang/debbuild.po -o $(DESTDIR)$(DATADIR)/locale/$$lang/LC_MESSAGES/debbuild.mo ; \
	done

install_user_macros:
	install -m 644 macros/.debmacros_default $(HOME_DIR)/.debmacros

install_user_build_tree:
	install -d $(HOME_DIR)/debbuild
	install -d $(HOME_DIR)/debbuild/BUILD
	install -d $(HOME_DIR)/debbuild/DEBS
	install -d $(HOME_DIR)/debbuild/SOURCES
	install -d $(HOME_DIR)/debbuild/SPECS
	install -d $(HOME_DIR)/debbuild/SDEBS

install_user_files: install_user_macros install_user_build_tree

.PHONY: clean_config clean_bin clean
clean_config:
	rm -vrf Makefile

clean_bin:
	rm -vrf $(OUT_SCRIPT)

clean: clean_config clean_bin

.PHONY: uninstall uninstall_user_macros uninstall_user_build_tree uninstall_user_files
uninstall:
	rm -vf $(DESTDIR)$(BINDIR)/debbuild
	rm -vrf $(DESTDIR)$(DEBCONFIGDIR)/debbuild
	find $(DESTDIR)$(MANDIR)/man8 -name "debbuild.8" -type f -delete
	find $(DESTDIR)$(DATADIR)/locale -name "debbuild.mo" -type f -delete

uninstall_user_macros:
	rm -vf $(HOME_DIR)/.debmacros

uninstall_user_build_tree:
	rm -vrf $(HOME_DIR)/debbuild

uninstall_user_files: uninstall_user_macros uninstall_user_build_tree
